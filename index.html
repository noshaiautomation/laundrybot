<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WhatsApp-style Demo Chat (n8n)</title>
<style>
  :root{--bg:#0b1220;--card:#ffffff;--muted:#f3f4f6;--accent:#10b981;--bot:#eef2ff;--me:#d1f7c4}
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,#0b1220 0%, #071021 100%); color:#0b1220; margin:0; padding:28px; display:flex; align-items:flex-start; justify-content:center; min-height:100vh}
  .frame{width:420px; background:var(--card); border-radius:12px; box-shadow:0 12px 40px rgba(2,6,23,.6); overflow:hidden; display:flex; flex-direction:column}
  header{background:#071032; color:#fff; padding:18px 20px}
  header h1{margin:0;font-size:18px}
  .subtitle{font-size:12px; opacity:.9; margin-top:6px}
  .messages{padding:16px; height:520px; overflow:auto; display:flex; flex-direction:column; gap:10px; background:linear-gradient(180deg,#f8fafc 0,#f3f4f6 100%)}
  .bubble{max-width:78%; padding:12px 14px; border-radius:12px; line-height:1.3; box-shadow:0 2px 6px rgba(2,6,23,.04); white-space:pre-wrap}
  .bot{align-self:flex-start; background:var(--bot); color:#0b1220}
  .me{align-self:flex-end; background:var(--me); color:#052e12}
  .controls{display:flex; gap:8px; padding:12px; border-top:1px solid #eef2f3; background:#fff}
  input[type="text"]{flex:1; padding:10px 12px; border-radius:10px; border:1px solid #e6e9ee; outline:none; font-size:14px}
  button.send{background:#0ea5e9; color:white; border:0; padding:10px 14px; border-radius:10px; cursor:pointer}
  .choices{display:flex; gap:8px; flex-wrap:wrap; padding:8px 16px}
  .chip{background:#0ea5e9;color:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-size:13px;border:0}
  .meta{font-size:12px;color:#6b7280;margin-top:6px}
  .small{font-size:12px;color:#6b7280}
  .loader{width:18px;height:18px;border-radius:50%;border:2px solid #cbd5e1;border-top-color:#0ea5e9; animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  footer.info{font-size:12px;padding:8px 12px;background:#f8fafc;color:#374151}
</style>
</head>
<body>
  <div class="frame" role="application" aria-label="Demo chat">
    <header>
      <h1>Demo Chatbot (n8n)</h1>
      <div class="subtitle">Start a chat. Example: "I want Pantry Box" or "Pick up my laundry at 7pm"</div>
    </header>

    <div class="messages" id="messages">
      <!-- initial bot greeting -->
      <div class="bubble bot">Hi! How can I help you today?</div>
    </div>

    <div class="choices" id="choices" style="display:none"></div>

    <div class="controls">
      <input id="input" type="text" placeholder="Type a messageâ€¦ " autocomplete="off" />
      <button id="send" class="send">Send</button>
    </div>

    <div style="padding:10px">
      <div class="small"></div>
    </div>
  </div>

<script>
/*
  Replace with your n8n webhook URL (the HTTP Trigger or Hosted Chat endpoint)
  Example: https://n8n.srv846726.hstgr.cloud/webhook/2f62ecce-9a0f-499b-9c9e-341dcc3362c6/chat
*/
const WEBHOOK_URL = "https://n8n.srv846726.hstgr.cloud/webhook/2f62ecce-9a0f-499b-9c9e-341dcc3362c6/chat";

const msgsEl = document.getElementById('messages');
const inp = document.getElementById('input');
const sendBtn = document.getElementById('send');
const choicesEl = document.getElementById('choices');

function appendBubble(text, who='bot') {
  const el = document.createElement('div');
  el.className = 'bubble ' + (who==='me' ? 'me' : 'bot');
  el.textContent = text;
  msgsEl.appendChild(el);
  msgsEl.scrollTop = msgsEl.scrollHeight;
}

function setChoices(list) {
  choicesEl.innerHTML = '';
  if (!Array.isArray(list) || list.length === 0) { choicesEl.style.display = 'none'; return; }
  choicesEl.style.display = 'flex';
  list.forEach(label => {
    const btn = document.createElement('button');
    btn.className = 'chip';
    btn.textContent = label;
    btn.onclick = () => {
      inp.value = label;
      send();
    };
    choicesEl.appendChild(btn);
  });
}

async function send() {
  const message = inp.value.trim();
  if (!message) return;
  appendBubble(message, 'me');
  inp.value = '';
  setChoices([]);

  // show inline loader bubble
  const loading = document.createElement('div');
  loading.className = 'bubble bot';
  loading.innerHTML = '<span class="loader" aria-hidden="true"></span> Processing...';
  msgsEl.appendChild(loading);
  msgsEl.scrollTop = msgsEl.scrollHeight;

  try {
    const body = { sessionId: 'demo-session', action: 'sendMessage', chatInput: message, name: 'Demo User' };
    const res = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    // accept both JSON and plain text replies
    let data;
    const contentType = res.headers.get('content-type') || '';
    if (contentType.includes('application/json')) {
      data = await res.json();
    } else {
      const txt = await res.text();
      try { data = JSON.parse(txt); } catch(e){ data = { reply: txt }; }
    }

    // n8n may return array of items - handle common shapes
    // Prefer: { reply: "text", choices: [...] }
    // Sometimes n8n returns [ { json: { reply: '...' } } ]
    let reply = '';
    let choices = [];

    if (typeof data === 'string') {
      reply = data;
    } else if (Array.isArray(data) && data.length && data[0].json) {
      // Hosted Chat might return [ { json: { reply, choices } } ]
      reply = data[0].json.reply ?? data[0].json.text ?? '';
      choices = data[0].json.choices ?? [];
    } else if (data.reply || data.text) {
      reply = data.reply ?? data.text ?? '';
      choices = data.choices ?? [];
    } else {
      // fallback: stringify small object
      reply = (typeof data === 'object') ? JSON.stringify(data) : String(data);
    }

    // replace the loading bubble with real reply
    loading.remove();
    appendBubble(reply || '(no reply)');

    // show choice buttons if provided
    setChoices(Array.isArray(choices) ? choices : []);
  } catch (err) {
    loading.remove();
    appendBubble('Error contacting bot. Check webhook URL and CORS.', 'bot');
    console.error(err);
  }
}

sendBtn.addEventListener('click', send);
inp.addEventListener('keydown', e => { if (e.key === 'Enter') send(); });

// quick examples on the right: add example buttons (optional)
// (function addExampleButtons(){
//   const examples = ['Mujhe Pantry Box chahiye', 'Weekly subscription', 'Pick up my laundry at 7pm'];
//   const container = document.createElement('div');
//   container.style.position = 'fixed';
//   container.style.right = '28px';
//   container.style.top = '28px';
//   container.style.display = 'flex';
//   container.style.flexDirection = 'column';
//   container.style.gap = '10px';
//   examples.forEach(ex => {
//     const b = document.createElement('button');
//     b.textContent = ex;
//     b.className = 'chip';
//     b.style.background = '#0ea5e9';
//     b.onclick = () => { inp.value = ex; send(); };
//     container.appendChild(b);
//   });
//   document.body.appendChild(container);
// })();
</script>
</body>
</html>
